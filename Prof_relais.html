<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Les aventuriers du rail V4.0</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 15px; background: #f0f2f5; }
        .header { background: #2c3e50; color: white; padding: 15px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap; }
        .btn { background: #27ae60; color: white; border: none; padding: 10px 15px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 0.9rem; }
        .btn-csv { background: #3498db; }
        .btn-reset { background: #e74c3c; font-size: 0.75rem; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1); font-size: 0.9rem; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background: #eee; }
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .content { background: white; padding: 25px; border-radius: 15px; width: 90%; max-width: 400px; text-align: center; }
        #reader { width: 100%; border-radius: 10px; }
        .big-pin { font-size: 5rem; font-weight: bold; color: #e74c3c; margin: 15px 0; border: 4px dashed #e74c3c; padding: 10px; background: #fff5f5; }
        .team-badge { display: inline-block; padding: 4px 10px; border-radius: 20px; color: white; font-weight: bold; text-transform: uppercase; font-size: 0.8rem; min-width: 85px; text-align: center; }
        .rouge { background: #DC143C; } .bleu { background: #1E90FF; } .vert { background: #2E7D32; }
        .jaune { background: #FFD700; color: black; } .noire { background: #222; color: white; } .blanc { background: #fff; color: #333; border: 1px solid #ccc; }
        .orange { background: #FF8C00; } .violet { background: #8A2BE2; }
        .relais-info { background: #f8f9fa; border: 1px solid #eee; margin: 3px 0; padding: 6px; border-radius: 4px; font-size: 0.8rem; }
        .note-badge { float: right; background: #27ae60; color: white; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
    </style>
</head>
<body onload="chargerDonnees()">

    <div class="header">
        <h2 style="margin:0; font-size:1.1rem;">Les aventuriers du rail V4.0</h2>
        <div style="display:flex; gap:5px;">
            <button class="btn" onclick="ouvrirScanner()">ðŸ“¸ SCAN</button>
            <button class="btn btn-csv" onclick="exporterCSV()">ðŸ“Š CSV</button>
            <button class="btn btn-reset" onclick="reinitialiserTout()">RESET</button>
        </div>
    </div>

    <table id="tableau-scores">
        <thead>
            <tr><th>Ã‰quipe</th><th>Distance</th><th>Historique (Compo | Note)</th></tr>
        </thead>
        <tbody id="corps-tableau"></tbody>
    </table>

    <div id="modale-scan" class="overlay"><div class="content"><div id="reader"></div><button class="btn" style="background:#e74c3c; margin-top:20px; width:100%" onclick="fermerTout()">ANNULER</button></div></div>
    <div id="modale-validation" class="overlay"><div class="content"><h2 id="nom-equipe-modale">---</h2><p id="detail-perf"></p><div id="code-pin" class="big-pin">---</div><button class="btn" style="width:100%;" onclick="validerScore()">VALIDER LE RELAIS</button></div></div>

<script>
const BAREMES = { 
    "4Filles": [38.8,38.7,38.3,37.9,37.5,37.2,36.8,36.5,36.1,35.8,35.4,35.1,34.7,34.4,34.0,33.7,33.3,33.0,32.6,32.3,32.0,31.7,31.4,31.1,30.8], 
    "3Filles": [37.0,36.9,36.5,36.2,35.7,35.4,35.1,34.8,34.5,34.2,33.9,33.6,33.2,33.0,32.6,32.3,32.0,31.7,31.3,31.0,30.7,30.4,29.1,29.8,29.5], 
    "2Filles": [35.2,35.1,34.8,34.5,33.9,33.6,33.3,33.1,32.9,32.6,32.3,32.1,31.8,31.5,31.2,31.0,30.7,30.4,30.0,29.7,29.4,29.1,28.8,28.5,28.1], 
    "1Filles": [33.3,33.2,33.0,32.7,32.1,31.8,31.6,31.3,31.2,31.0,30.8,30.5,30.3,30.1,29.8,29.6,29.3,29.0,28.7,28.4,28.1,27.8,27.5,27.1,26.8], 
    "0Filles": [31.5,31.4,31.2,31.0,30.8,30.6,30.4,30.2,30.0,29.8,29.6,29.4,29.2,29.0,28.8,28.6,28.4,28.2,28.0,27.7,27.4,27.1,26.8,26.5,26.4] 
};
const POINTS = [0,0.25,0.5,0.75,1,1.25,1.5,1.75,2,2.25,2.5,2.75,3,3.25,3.5,3.75,4,4.25,4.5,4.75,5,5.25,5.5,5.75,6];

let html5QrCode = null, donneesScan = null, scoresParEquipe = {}, idsScannes = new Set();

function chargerDonnees() {
    const s = localStorage.getItem('rf_v40_prof'), i = localStorage.getItem('rf_v40_ids');
    if(s) scoresParEquipe = JSON.parse(s);
    if(i) idsScannes = new Set(JSON.parse(i));
    dessinerTableau();
}

function calculerNote(temps, nbF) {
    let nomBareme = nbF + "Filles";
    let baremeChoisi = BAREMES[nomBareme];
    let note = 0;
    // On cherche la note en partant de la meilleure (index 24)
    for (let i = baremeChoisi.length - 1; i >= 0; i--) {
        if (parseFloat(temps) <= baremeChoisi[i]) {
            note = POINTS[i];
            break; 
        }
    }
    return note.toFixed(2);
}

function exporterCSV() {
    let csv = "Equipe;Distance;Relais_Compo;Chrono;Note\n";
    Object.entries(scoresParEquipe).forEach(([couleur, data]) => {
        data.relais.forEach(r => {
            csv += `${couleur};${data.distance};${r.compo};${r.chrono};${r.note}\n`;
        });
    });
    const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' }); // Ajout du BOM pour Excel
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.setAttribute("download", "resultats_rail_fond_V4.csv");
    link.click();
}

function ouvrirScanner() {
    document.getElementById("modale-scan").style.display = "flex";
    if (!html5QrCode) html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (text) => {
        try {
            let d = JSON.parse(text);
            if (idsScannes.has(d.id)) { alert("DÃ‰JÃ€ SCANNÃ‰ !"); return; }
            donneesScan = d;
            document.getElementById("modale-scan").style.display = "none";
            document.getElementById("nom-equipe-modale").innerText = "Ã‰QUIPE " + d.team.toUpperCase();
            document.getElementById("code-pin").innerText = d.pin;
            document.getElementById("detail-perf").innerText = `Relais ${d.player.replace(/[12-]/g, '')} : ${d.tempsRealise}s`;
            document.getElementById("modale-validation").style.display = "flex";
            html5QrCode.stop();
        } catch(e) { alert("QR non valide"); }
    }).catch(err => alert("Erreur CamÃ©ra : " + err));
}

function validerScore() {
    const eq = donneesScan.team;
    const nbF = (donneesScan.player.match(/2/g) || []).length;
    const note = calculerNote(donneesScan.tempsRealise, nbF);
    if (!scoresParEquipe[eq]) scoresParEquipe[eq] = { distance: 0, relais: [] };
    scoresParEquipe[eq].distance += 200;
    scoresParEquipe[eq].relais.push({ compo: donneesScan.player.replace(/[12-]/g, ''), chrono: donneesScan.tempsRealise, note: note });
    idsScannes.add(donneesScan.id);
    localStorage.setItem('rf_v40_prof', JSON.stringify(scoresParEquipe));
    localStorage.setItem('rf_v40_ids', JSON.stringify(Array.from(idsScannes)));
    dessinerTableau();
    document.getElementById("modale-validation").style.display = "none";
}

function dessinerTableau() {
    let html = "";
    Object.entries(scoresParEquipe).sort((a,b) => b[1].distance - a[1].distance).forEach(([couleur, data]) => {
        let h = data.relais.map(r => `<div class="relais-info"><span class="note-badge">${r.note}/6</span><b>${r.compo}</b> : ${r.chrono}s</div>`).join('');
        html += `<tr><td><span class="team-badge ${couleur}">${couleur}</span></td><td style="text-align:center;"><b>${data.distance}m</b></td><td>${h}</td></tr>`;
    });
    document.getElementById("corps-tableau").innerHTML = html;
}

function fermerTout() { 
    if(html5QrCode) {
        html5QrCode.stop().then(() => {
            document.getElementById("modale-scan").style.display='none';
        });
    } else {
        document.querySelectorAll('.overlay').forEach(o => o.style.display='none');
    }
}

function reinitialiserTout() { if(confirm("Effacer toutes les donnÃ©es prof ?")) { localStorage.clear(); location.reload(); } }
</script>
</body>
</html>