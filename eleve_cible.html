<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Les aventuriers du rail - 1/2 fond - Perf cible V4.0</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --p: #2c3e50; --s: #27ae60; --d: #e74c3c; --b: #3498db; }
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f0f2f5; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        .screen { width: 100%; height: 100vh; display: none; flex-direction: column; overflow-y: auto; }
        .active { display: flex; }
        .padding { padding: 15px; }
        .card { background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 12px; margin-bottom: 10px; border-left: 5px solid var(--p); }
        .player-row { display: flex; justify-content: space-between; padding: 15px; background: #f8f9fa; border-radius: 6px; margin-bottom: 8px; cursor: pointer; border: 1px solid #ddd; font-weight: bold; }
        .inventory { display: flex; flex-wrap: wrap; gap: 6px; margin: 10px 0; }
        .wagon-pill { padding: 8px 12px; border-radius: 4px; font-weight: bold; border: 1px solid #333; }
        .prog-container { background: #eee; border-radius: 10px; height: 18px; overflow: hidden; margin: 8px 0; border: 1px solid #ccc; }
        .prog-bar { background: var(--b); height: 100%; width: 0%; transition: width 0.5s ease; }
        #map-area { background: #cbdceb; flex-grow: 1; overflow: auto; position: relative; display: flex; align-items: flex-start; justify-content: center; }
        #map-container { transform-origin: top center; transition: transform 0.3s ease; }
        embed { width: 1000px; height: 960px; pointer-events: none; }
        .btn-zoom { background: var(--p); color: white; border: 2px solid white; width: 45px; height: 45px; border-radius: 8px; cursor: pointer; }
        select, input, button { width: 100%; padding: 12px; margin-top: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 1rem; }
        .btn-valid { background: var(--s); color: white; border: none; font-weight: bold; cursor: pointer; }
        .btn-cancel { background: var(--d); color: white; border: none; cursor: pointer; }
        .btn-nav { background: var(--b); color: white; font-weight: bold; border: none; padding: 15px; margin-bottom: 10px; border-radius: 8px; }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal-content { background: white; padding: 25px; border-radius: 15px; text-align: center; width: 90%; max-width: 400px; }
        .rouge { background: #DC143C !important; color: white !important; }
        .bleu { background: #1E90FF !important; color: white !important; }
        .vert { background: #2E7D32 !important; color: white !important; }
        .jaune { background: #FFD700 !important; color: black !important; }
        .noire { background: #222 !important; color: white !important; }
        .blanc { background: #fff !important; color: black !important; border: 2px solid #333 !important; }
        .orange { background: #FF8C00 !important; color: white !important; }
        .violet { background: #8A2BE2 !important; color: white !important; }
        .rose { background: #FF69B4; color: white; }
        .deco-card { min-height: 60px; border: none !important; pointer-events: none; margin: 10px 0; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        /* Nouveau Style Chrono */
        #chrono-display { font-size: 3.5rem; font-family: monospace; font-weight: bold; margin: 10px 0; color: var(--p); }
        .btn-chrono { background: var(--p); color: white; font-size: 1.2rem; }
        .setup-row { display: flex; gap: 5px; margin-bottom: 5px; }
    </style>
</head>
<body onload="checkSave()">

    <div id="screen-setup" class="screen active padding">
        <h2 style="text-align: center;">üöÇ Les aventuriers du rail - 1/2 fond V4.0</h2>
        <div id="names-inputs">
            <div class="setup-row"><input type="text" class="input-names" placeholder="Pr√©nom"><input type="number" class="input-targets" placeholder="Cible (sec)"></div>
            <div class="setup-row"><input type="text" class="input-names" placeholder="Pr√©nom"><input type="number" class="input-targets" placeholder="Cible (sec)"></div>
            <div class="setup-row"><input type="text" class="input-names" placeholder="Pr√©nom"><input type="number" class="input-targets" placeholder="Cible (sec)"></div>
            <div class="setup-row"><input type="text" class="input-names" placeholder="Pr√©nom"><input type="number" class="input-targets" placeholder="Cible (sec)"></div>
            <div class="setup-row"><input type="text" class="input-names" placeholder="Pr√©nom"><input type="number" class="input-targets" placeholder="Cible (sec)"></div>
        </div>
        <select id="team-color" style="margin-top:15px;">
            <option value="rouge">üî¥ Rouge</option><option value="bleu">üîµ Bleue</option><option value="vert">üü¢ Verte</option>
            <option value="jaune">üü° Jaune</option><option value="noire">‚ö´ Noire</option><option value="blanc">‚ö™ Blanche</option>
            <option value="orange">üü† Orange</option><option value="violet">üü£ Violette</option>
        </select>
        <button class="btn-valid" onclick="startGame()" style="margin-top:20px;">D√âMARRER LA MISSION</button>
    </div>

    <div id="screen-game" class="screen padding">
        <div id="deco-top" class="card deco-card"></div>
        <button class="btn-nav" onclick="showScreen('screen-map')">üó∫Ô∏è VOIR LA CARTE</button>
        <div class="card" style="background:#2c3e50; color:white; text-align:center;"> <span id="m-title">---</span></div>
        <div id="team-score-card" class="card" style="text-align: center;"><small>SCORE √âQUIPE :</small><br><strong style="font-size: 2rem;" id="dist-team">0 m</strong></div>
        <div class="card"><small>PROGRESSION MISSION :</small><div class="prog-container"><div id="mission-progress-bar" class="prog-bar"></div></div><div id="mission-progress-text" style="text-align:center; font-size:0.8rem; font-weight:bold;">0 / 0 wagons</div></div>
        <div id="players-list"></div>
        <div id="inventory-zone" class="inventory"></div>
        <div class="card">
            <h3 style="margin:0">üõ§ Poser un rail</h3>
            <select id="sel-a"></select> vers <select id="sel-b"></select>
            <button class="btn-valid" onclick="buildRoute()">Valider la construction</button>
        </div>
        <div class="card" style="border-left-color: var(--b);"><h4 style="margin:0">üìú Historique</h4><ul id="trajet-list-ul" style="font-size: 0.85rem; padding-left: 20px;"></ul></div>
        <button onclick="resetGame()" style="background:var(--d); color:white; border:none; margin-top:30px; padding:8px; font-size:0.7rem; opacity:0.8;">R√âINITIALISER TOUTE LA PARTIE</button>
        <div id="deco-bottom" class="card deco-card" style="margin-top:20px;"></div>
    </div>

    <div id="screen-map" class="screen">
        <button class="btn-nav" style="position:fixed; top:10px; left:10px; z-index:100; width:auto;" onclick="showScreen('screen-game')">‚¨Ö RETOUR</button>
        <div id="map-area">
            <div style="position:fixed; bottom:20px; right:20px; z-index:100; display:flex; flex-direction:column; gap:10px;">
                <button class="btn-zoom" onclick="zoomMap(0.2)">+</button><button class="btn-zoom" onclick="zoomMap(-0.2)">-</button>
            </div>
            <div id="map-container"><embed src="carte.svg" type="image/svg+xml"></div>
        </div>
    </div>

    <div id="modal-qr" class="modal">
        <div class="modal-content">
            <h2 id="qr-title">Validation</h2>
            <div id="chrono-zone">
                <div id="chrono-display">0.0</div>
                <button id="btn-chrono-toggle" class="btn-chrono" onclick="toggleChrono()">D√âPART</button>
            </div>
            <div id="qr-success-zone" style="display:none;">
                <div id="qrcode" style="display:flex; justify-content:center; margin:15px;"></div>
                <p style="font-size:0.7rem; color:#666;">ID Course : <span id="display-id"></span></p>
                <input type="number" id="input-pin" style="font-size: 2.5rem; text-align: center;" placeholder="000">
                <button class="btn-valid" onclick="checkPin()">CONFIRMER LE PIN</button>
            </div>
            <div id="qr-error-msg" style="color:var(--d); font-weight:bold; margin-top:15px; display:none;">√âcart trop important (>5s) ! Recommencez.</div>
            <button class="btn-cancel" onclick="closeModalQR()" style="margin-top:10px;">ANNULER / FERMER</button>
        </div>
    </div>
    
    <div id="modal-chance" class="modal"><div class="modal-content"><h2>Bravo !</h2><p>Choisis ton wagon :</p><div id="chance-buttons" class="inventory" style="justify-content:center"></div></div></div>
    
    <div id="modal-win" class="modal">
        <div class="modal-content" style="background:#f1c40f;">
            <h1>üèÜ VICTOIRE !</h1>
            <button class="btn-valid" onclick="startSecondaryMission()" style="background:#2ecc71;">MISSION SECONDAIRE (+ courte)</button>
            <button class="btn-valid" onclick="resetGame()" style="background:#e67e22; margin-top:10px;">REJOUER (Nouvelle partie)</button>
        </div>
    </div>

<script>
const RAIL_DATA = [{u:"Calais",v:"Dunkerque",cost:1,col:["jaune"]},{u:"Dunkerque",v:"Lille",cost:2,col:["bleu"]},{u:"Dunkerque",v:"B√©thune",cost:3,col:["rouge"]},{u:"B√©thune",v:"Douai",cost:1,col:["blanc"]},{u:"Douai",v:"Amiens",cost:2,col:["bleu"]},{u:"Douai",v:"Valenciennes",cost:2,col:["noire"]},{u:"Lille",v:"Valenciennes",cost:4,col:["orange"]},{u:"Valenciennes",v:"Thionville",cost:5,col:["noire","rose"]},{u:"Valenciennes",v:"Reims",cost:2,col:["jaune"]},{u:"Amiens",v:"Paris",cost:3,col:["orange","vert"]},{u:"Amiens",v:"Le Havre",cost:4,col:["rouge"]},{u:"Le Havre",v:"Rouen",cost:2,col:["noire"]},{u:"Rouen",v:"Paris",cost:3,col:["blanc"]},{u:"Paris",v:"Troyes",cost:7,col:["rose","jaune"]},{u:"Reims",v:"Nancy",cost:5,col:["rouge"]},{u:"Reims",v:"Troyes",cost:4,col:["vert"]},{u:"Nancy",v:"Troyes",cost:2,col:["bleu"]},{u:"Thionville",v:"Nancy",cost:3,col:["orange"]},{u:"Thionville",v:"Strasbourg",cost:5,col:["rose"]},{u:"Nancy",v:"Strasbourg",cost:4,col:["jaune"]},{u:"Strasbourg",v:"Mulhouse",cost:3,col:["blanc"]},{u:"Mulhouse",v:"Montb√©liard",cost:1,col:["vert"]},{u:"Montb√©liard",v:"Besan√ßon",cost:2,col:["jaune"]},{u:"Besan√ßon",v:"Troyes",cost:3,col:["rouge","vert"]},{u:"Besan√ßon",v:"Dijon",cost:2,col:["bleu"]},{u:"Besan√ßon",v:"Annecy",cost:4,col:["blanc"]},{u:"Dijon",v:"Lyon",cost:4,col:["jaune","rouge"]},{u:"Le Havre",v:"Caen",cost:1,col:["bleu"]},{u:"Paris",v:"Le Mans",cost:4,col:["vert"]},{u:"Paris",v:"Orl√©ans",cost:4,col:["rouge","bleu"]},{u:"Orl√©ans",v:"Le Mans",cost:3,col:["blanc"]},{u:"Le Mans",v:"Rennes",cost:5,col:["vert"]},{u:"Caen",v:"Le Mans",cost:4,col:["orange"]},{u:"Caen",v:"Rennes",cost:5,col:["blanc","rose"]},{u:"Rennes",v:"Brest",cost:7,col:["rouge"]},{u:"Brest",v:"Lorient",cost:3,col:["orange"]},{u:"Lorient",v:"Saint-Nazaire",cost:3,col:["jaune"]},{u:"Rennes",v:"Saint-Nazaire",cost:3,col:["noire"]},{u:"Rennes",v:"Nantes",cost:3,col:["bleu"]},{u:"Nantes",v:"Saint-Nazaire",cost:2,col:["blanc"]},{u:"Nantes",v:"Angers",cost:2,col:["rouge"]},{u:"Angers",v:"Tours",cost:3,col:["bleu"]},{u:"Tours",v:"Orl√©ans",cost:3,col:["vert"]},{u:"Nantes",v:"Poitiers",cost:5,col:["rose"]},{u:"Tours",v:"Poitiers",cost:2,col:["blanc"]},{u:"Nantes",v:"Bordeaux",cost:8,col:["noire","orange"]},{u:"Poitiers",v:"Limoges",cost:3,col:["rouge"]},{u:"Limoges",v:"Bordeaux",cost:5,col:["vert","bleu"]},{u:"Limoges",v:"Clermont-Ferrand",cost:4,col:["blanc","jaune"]},{u:"Clermont-Ferrand",v:"Lyon",cost:2,col:["orange"]},{u:"Clermont-Ferrand",v:"Saint-Etienne",cost:3,col:["rouge"]},{u:"Lyon",v:"Saint-Etienne",cost:1,col:["vert"]},{u:"Lyon",v:"Grenoble",cost:4,col:["bleu"]},{u:"Grenoble",v:"Annecy",cost:3,col:["vert"]},{u:"Saint-Etienne",v:"Valence",cost:2,col:["noire"]},{u:"Valence",v:"N√Æmes",cost:4,col:["rouge","jaune"]},{u:"N√Æmes",v:"Montpellier",cost:2,col:["orange","bleu"]},{u:"N√Æmes",v:"Marseille",cost:1,col:["blanc","bleu"]},{u:"Marseille",v:"Toulon",cost:2,col:["jaune"]},{u:"Toulon",v:"Nice",cost:3,col:["vert"]},{u:"Montpellier",v:"Toulouse",cost:4,col:["rouge","vert"]},{u:"Toulouse",v:"Perpignan",cost:3,col:["blanc"]},{u:"Toulouse",v:"Pau",cost:5,col:["jaune"]},{u:"Toulouse",v:"Bordeaux",cost:6,col:["rose"]},{u:"Bordeaux",v:"Pau",cost:6,col:["rouge"]},{u:"Pau",v:"Bayonne",cost:4,col:["vert"]},{u:"Orl√©ans",v:"Limoges",cost:7,col:["jaune", "bleu"]}];

const MISSIONS_3 = [{s:"Calais",e:"Troyes",w:13},{s:"B√©thune",e:"Tours",w:13},{s:"Brest",e:"Le Havre",w:13},{s:"Lyon",e:"Nice",w:13},{s:"Bayonne",e:"Montpellier",w:13},{s:"Lorient",e:"Limoges",w:13},{s:"Poitiers",e:"Le Havre",w:13},{s:"Douai",e:"Montb√©liard",w:13}];
const MISSIONS_4 = [{s:"Calais",e:"Besan√ßon",w:16},{s:"Dunkerque",e:"Tours",w:16},{s:"Lorient",e:"Amiens",w:16},{s:"Montb√©liard",e:"Marseille",w:16},{s:"Bayonne",e:"Marseille",w:16},{s:"N√Æmes",e:"Poitiers",w:16},{s:"Tours",e:"Toulouse",w:16},{s:"Saint-Nazaire",e:"Pau",w:16}];
const MISSIONS_5 = [{s:"Calais",e:"Mulhouse",w:19},{s:"Douai",e:"Brest",w:19},{s:"Amiens",e:"Bordeaux",w:19},{s:"Mulhouse",e:"Toulon",w:19},{s:"Poitiers",e:"Toulon",w:19},{s:"Bordeaux",e:"Rouen",w:19},{s:"Perpignan",e:"Tours",w:19},{s:"Montb√©liard",e:"Bordeaux",w:19}];
const MISSIONS_SEC = [{s:"Troyes",e:"Annecy",w:7},{s:"Tours",e:"Saint-Nazaire",w:7},{s:"Le Havre",e:"B√©thune",w:7},{s:"Nice",e:"Montpellier",w:8},{s:"Montpellier",e:"Grenoble",w:8},{s:"Limoges",e:"Saint-Etienne",w:7},{s:"Montb√©liard",e:"Lyon",w:8},{s:"Besan√ßon",e:"Grenoble",w:7},{s:"Amiens",e:"Orl√©ans",w:7},{s:"Marseille",e:"Toulouse",w:7},{s:"Poitiers",e:"Angers",w:7},{s:"Toulouse",e:"Marseille",w:7},{s:"Pau",e:"Perpignan",w:8},{s:"Mulhouse",e:"Nancy",w:7},{s:"Brest",e:"Nantes",w:8},{s:"Bordeaux",e:"Perpignan",w:9},{s:"Rouen",e:"Douai",w:8},{s:"Toulon",e:"Toulouse",w:9}];

let state = { scale: 1, color: null, mission: null, built: [], distance: 0, inv: {jaune:0,orange:0,rose:0,noire:0,vert:0,bleu:0,rouge:0,blanc:0}, individual: {}, targetWagons: 0, currentPlayer: null, currentPin: null, isSecondary: false };

// Variables Chrono
let timer = null;
let startTime = 0;
let currentTime = 0;

function clean(s) { return s.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, ''); }
function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
function saveGame() { localStorage.setItem('railfond_v25', JSON.stringify(state)); }
function checkSave() { let s = localStorage.getItem('railfond_v25'); if(s) { state = JSON.parse(s); setupCities(); showScreen('screen-game'); updateUI(); } }
function resetGame() { if(confirm("Supprimer toute la progression ?")) { localStorage.removeItem('railfond_v25'); location.reload(); } }

function setupCities() {
    let c = [...new Set(RAIL_DATA.flatMap(r => [r.u, r.v]))].sort();
    let sa = document.getElementById('sel-a'), sb = document.getElementById('sel-b');
    sa.innerHTML = sb.innerHTML = ""; c.forEach(x => { sa.add(new Option(x,x)); sb.add(new Option(x,x)); });
}

function startGame() {
    let inputs = Array.from(document.querySelectorAll('.input-names'));
    let targets = Array.from(document.querySelectorAll('.input-targets'));
    let validCount = 0;

    inputs.forEach((inp, i) => {
        let name = inp.value.trim();
        let target = parseFloat(targets[i].value);
        if(name !== "" && !isNaN(target)) {
            state.individual[clean(name)] = { dist: 0, target: target, realName: name };
            validCount++;
        }
    });

    if(!validCount) return alert("Pr√©noms et Cibles obligatoires");
    state.color = document.getElementById('team-color').value;
    let pool = (validCount >= 5) ? MISSIONS_5 : (validCount === 4 ? MISSIONS_4 : MISSIONS_3);
    let m = pool[Math.floor(Math.random()*pool.length)];
    state.mission = {s: m.s, e: m.e};
    state.targetWagons = m.w;
    setupCities(); showScreen('screen-game'); saveGame(); updateUI();
}

function updateUI() {
    document.getElementById('deco-top').className = "card deco-card " + state.color;
    document.getElementById('deco-bottom').className = "card deco-card " + state.color;
    let sc = document.getElementById('team-score-card'); sc.className = "card " + state.color;
    document.getElementById('dist-team').innerText = state.distance + " m";
    let prefix = state.isSecondary ? "ü•à SECONDAIRE : " : "üìç MISSION : ";
    document.getElementById('m-title').innerText = prefix + state.mission.s + " ‚ûî " + state.mission.e;
    let curW = state.built.reduce((acc, b) => { 
        let r = RAIL_DATA.find(rd => (rd.u==b.u && rd.v==b.v) || (rd.v==b.u && rd.u==b.v));
        return acc + (r ? r.cost : 0); 
    }, 0);
    let p = Math.min(100, Math.round((curW/state.targetWagons)*100));
    document.getElementById('mission-progress-bar').style.width = p + "%";
    document.getElementById('mission-progress-text').innerText = `${curW} / ${state.targetWagons} wagons (${p}%)`;
    let pl = document.getElementById('players-list'); pl.innerHTML = "";
    for(let n in state.individual) {
        let pData = state.individual[n];
        let r = document.createElement('div'); r.className='player-row'; 
        r.innerHTML=`<div><span>${pData.realName}</span><br><small>Cible: ${pData.target}s</small></div><span>${pData.dist}m</span>`;
        r.onclick=()=>askValidation(n); pl.appendChild(r);
    }
    let iz = document.getElementById('inventory-zone'); iz.innerHTML = "";
    for(let c in state.inv) if(state.inv[c]>0) iz.innerHTML += `<div class="wagon-pill ${c}">${state.inv[c]}</div>`;
    document.getElementById('trajet-list-ul').innerHTML = state.built.map(r => `<li>${r.u} ‚Üî ${r.v}</li>`).reverse().join('');
}

function askValidation(name) {
    state.currentPlayer = name;
    state.currentPin = Math.floor(100 + Math.random() * 899);
    
    // Reset Modal
    document.getElementById('chrono-display').innerText = "0.0";
    document.getElementById('btn-chrono-toggle').innerText = "D√âPART";
    document.getElementById('qr-success-zone').style.display = "none";
    document.getElementById('qr-error-msg').style.display = "none";
    document.getElementById('chrono-zone').style.display = "block";
    
    document.getElementById('qr-title').innerText = "Course de " + state.individual[name].realName;
    document.getElementById('modal-qr').style.display = 'flex';
}

function toggleChrono() {
    let btn = document.getElementById('btn-chrono-toggle');
    if(!timer) {
        startTime = Date.now();
        btn.innerText = "STOP";
        btn.style.background = "var(--d)";
        timer = setInterval(() => {
            currentTime = ((Date.now() - startTime) / 1000).toFixed(1);
            document.getElementById('chrono-display').innerText = currentTime;
        }, 100);
    } else {
        clearInterval(timer);
        timer = null;
        btn.innerText = "RESET";
        btn.style.background = "var(--p)";
        verifyTime();
    }
}

function verifyTime() {
    let pData = state.individual[state.currentPlayer];
    let diff = Math.abs(currentTime - pData.target);

    if(diff <= 5) {
        generateQRCode(currentTime, pData.target);
    } else {
        document.getElementById('qr-error-msg').style.display = "block";
        setTimeout(() => {
            document.getElementById('chrono-display').innerText = "0.0";
            document.getElementById('btn-chrono-toggle').innerText = "D√âPART";
        }, 2000);
    }
}

function generateQRCode(real, target) {
    const rid = state.currentPlayer + "_" + Date.now();
    document.getElementById('display-id').innerText = rid;
    
    const data = { 
        team: state.color, 
        player: state.individual[state.currentPlayer].realName, 
        dist: state.distance + 250, 
        pin: state.currentPin, 
        id: rid,
        tempsRealise: real,
        tempsCible: target
    };

    document.getElementById('qrcode').innerHTML = "";
    new QRCode(document.getElementById("qrcode"), { text: JSON.stringify(data), width: 180, height: 180 });
    
    document.getElementById('chrono-zone').style.display = "none";
    document.getElementById('qr-success-zone').style.display = "block";
}

function closeModalQR() { 
    clearInterval(timer); 
    timer = null;
    document.getElementById('modal-qr').style.display = 'none'; 
    document.getElementById('input-pin').value = ""; 
}

function checkPin() {
    if(parseInt(document.getElementById('input-pin').value) === state.currentPin) {
        state.distance += 250; state.individual[state.currentPlayer].dist += 250;
        closeModalQR(); showChanceModal(); saveGame(); updateUI();
    } else alert("Code PIN incorrect");
}

function showChanceModal() {
    let cs = ['jaune','orange','rose','noire','vert','bleu','rouge','blanc'], pk = cs.sort(()=>0.5-Math.random()).slice(0,4);
    let ct = document.getElementById('chance-buttons'); ct.innerHTML = "";
    pk.forEach(c => {
        let b = document.createElement('button'); b.className = `wagon-pill ${c}`; b.innerText = c.toUpperCase();
        b.onclick = () => { state.inv[c]++; document.getElementById('modal-chance').style.display="none"; saveGame(); updateUI(); };
        ct.appendChild(b);
    });
    document.getElementById('modal-chance').style.display = "flex";
}

function buildRoute() {
    let a = document.getElementById('sel-a').value, b = document.getElementById('sel-b').value;
    if (a === b) return alert("Villes identiques");
    let r = RAIL_DATA.find(x => (x.u === a && x.v === b) || (x.v === a && x.u === b));
    if(!r) return alert("Liaison absente !");
    let exist = state.built.find(x => (x.u === a && x.v === b) || (x.v === a && x.u === b));
    if(exist) return alert("Rail d√©j√† pos√© !");
    let col = r.col.length > 1 ? prompt(`Couleur (${r.col.join('/')}) ?`).toLowerCase() : r.col[0];
    if(state.inv[col] >= r.cost) { 
        state.inv[col] -= r.cost; state.built.push({u:a, v:b}); saveGame(); updateUI(); checkWin(); 
    } else alert("Manque de wagons " + col);
}

function checkWin() {
    let v = new Set(), q = [state.mission.s];
    while(q.length > 0) {
        let curr = q.shift(); if(curr === state.mission.e) { document.getElementById('modal-win').style.display='flex'; return; }
        v.add(curr); state.built.forEach(r => { 
            if(r.u==curr && !v.has(r.v)) q.push(r.v); if(r.v==curr && !v.has(r.u)) q.push(r.u); 
        });
    }
}
function zoomMap(v) { state.scale += v; document.getElementById('map-container').style.transform = `scale(${state.scale})`; }
</script>
</body>
</html>