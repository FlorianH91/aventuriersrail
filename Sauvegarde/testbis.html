<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Les aventuriers du rail V4.0</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --p: #2c3e50; --s: #27ae60; --d: #e74c3c; --b: #3498db; }
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f0f2f5; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        .banner-flow { width: 100%; height: 60px; flex-shrink: 0; transition: background 0.3s ease; }
        .screen { width: 100%; height: 100%; display: none; flex-direction: column; overflow-y: auto; }
        .active { display: flex; }
        .padding { padding: 15px; }
        .card { background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 12px; margin-bottom: 10px; border-left: 5px solid var(--p); }
        .player-row { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #f8f9fa; border-radius: 6px; margin-bottom: 8px; border: 1px solid #ddd; font-weight: bold; }
        .inventory { display: flex; flex-wrap: wrap; gap: 6px; margin: 10px 0; }
        .wagon-pill { padding: 8px 12px; border-radius: 4px; font-weight: bold; border: 1px solid #333; display: inline-block; }
        .prog-container { background: #eee; border-radius: 10px; height: 18px; overflow: hidden; margin: 8px 0; border: 1px solid #ccc; }
        .prog-bar { background: var(--b); height: 100%; width: 0%; transition: width 0.5s ease; }
        #map-area { background: #cbdceb; flex-grow: 1; overflow: auto; position: relative; display: flex; align-items: flex-start; justify-content: center; }
        #map-container { transform-origin: top center; transition: transform 0.3s ease; }
        embed { width: 1000px; height: 960px; pointer-events: none; }
        .btn-zoom { background: var(--p); color: white; border: 2px solid white; width: 45px; height: 45px; border-radius: 8px; cursor: pointer; }
        select, input, button { width: 100%; padding: 12px; margin-top: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 1rem; }
        .btn-valid { background: var(--s); color: white; border: none; font-weight: bold; cursor: pointer; }
        .btn-cancel { background: var(--d); color: white; border: none; cursor: pointer; }
        .btn-nav { background: var(--b); color: white; font-weight: bold; border: none; padding: 15px; margin-bottom: 10px; border-radius: 8px; }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 4000; }
        .modal-content { background: white; padding: 25px; border-radius: 15px; text-align: center; width: 90%; max-width: 400px; }
        .rouge { background: #DC143C !important; color: white !important; }
        .bleu { background: #1E90FF !important; color: white !important; }
        .vert { background: #2E7D32 !important; color: white !important; }
        .jaune { background: #FFD700 !important; color: black !important; }
        .noire { background: #222 !important; color: white !important; }
        .blanc { background: #fff !important; color: black !important; border: 2px solid #333 !important; }
        .orange { background: #FF8C00 !important; color: white !important; }
        .rose { background: #FF69B4; color: white; }
        .violet { background: #8A2BE2 !important; color: white !important; }
        #chrono-display { font-size: 3.5rem; font-family: monospace; font-weight: bold; margin: 10px 0; color: var(--p); }
        .btn-chrono { background: var(--p); color: white; font-size: 1.2rem; }
        .chk-relais { width: 25px; height: 25px; margin: 0; }
        .id-badge { background: #333; color: white; padding: 2px 6px; border-radius: 4px; margin-right: 8px; font-family: monospace; font-size: 0.8rem; }
        .order-badge { background: var(--b); color: white; padding: 2px 8px; border-radius: 50%; margin-left: 10px; font-size: 0.9rem; }
        .hist-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; margin-top: 5px; }
        .hist-table th, .hist-table td { border: 1px solid #ddd; padding: 8px 4px; text-align: center; }
    </style>
</head>
<body onload="checkSave()">

    <div id="screen-setup" class="screen active padding">
        <div id="banner-setup-top" class="banner-flow"></div>
        <h2 style="text-align: center;">üèÉ‚Äç‚ôÇÔ∏è Les aventuriers du rail V4.0</h2>
        <div id="names-inputs">
            <div style="display:flex; gap:5px; margin-bottom:5px;"><input type="text" class="input-names" placeholder="Pr√©nom"><select class="input-sex" style="width:70px"><option value="F">F</option><option value="G" selected>G</option></select><input type="number" step="0.01" class="input-targets" placeholder="R√©f 50m"></div>
            <div style="display:flex; gap:5px; margin-bottom:5px;"><input type="text" class="input-names" placeholder="Pr√©nom"><select class="input-sex" style="width:70px"><option value="F">F</option><option value="G" selected>G</option></select><input type="number" step="0.01" class="input-targets" placeholder="R√©f 50m"></div>
            <div style="display:flex; gap:5px; margin-bottom:5px;"><input type="text" class="input-names" placeholder="Pr√©nom"><select class="input-sex" style="width:70px"><option value="F">F</option><option value="G" selected>G</option></select><input type="number" step="0.01" class="input-targets" placeholder="R√©f 50m"></div>
            <div style="display:flex; gap:5px; margin-bottom:5px;"><input type="text" class="input-names" placeholder="Pr√©nom"><select class="input-sex" style="width:70px"><option value="F">F</option><option value="G" selected>G</option></select><input type="number" step="0.01" class="input-targets" placeholder="R√©f 50m"></div>
            <div style="display:flex; gap:5px; margin-bottom:5px;"><input type="text" class="input-names" placeholder="Pr√©nom"><select class="input-sex" style="width:70px"><option value="F">F</option><option value="G" selected>G</option></select><input type="number" step="0.01" class="input-targets" placeholder="R√©f 50m"></div>
            <div style="display:flex; gap:5px; margin-bottom:5px;"><input type="text" class="input-names" placeholder="Pr√©nom"><select class="input-sex" style="width:70px"><option value="F">F</option><option value="G" selected>G</option></select><input type="number" step="0.01" class="input-targets" placeholder="R√©f 50m"></div>
        </div>
        <select id="team-color" style="margin-top:15px;" onchange="updateBanners()">
            <option value="rouge">üî¥ Rouge</option><option value="bleu">üîµ Bleue</option><option value="vert">üü¢ Verte</option>
            <option value="jaune">üü° Jaune</option><option value="noire">‚ö´ Noire</option><option value="blanc">‚ö™ Blanche</option>
            <option value="orange">üü† Orange</option><option value="violet">üü£ Violette</option>
        </select>
        <button class="btn-valid" onclick="startGame()" style="margin-top:20px;">D√âMARRER LA MISSION</button>
        <div id="banner-setup-bottom" class="banner-flow" style="margin-top:20px;"></div>
    </div>

    <div id="screen-game" class="screen">
        <div id="banner-game-top" class="banner-flow"></div>
        <div class="padding">
            <button class="btn-nav" onclick="showScreen('screen-map')">üó∫Ô∏è VOIR LA CARTE</button>
            <div class="card" style="background:#2c3e50; color:white; text-align:center;"> <span id="m-title">---</span></div>
            <div id="team-score-card" class="card" style="text-align: center;"><small>SCORE √âQUIPE :</small><br><strong style="font-size: 2rem;" id="dist-team">0 m</strong></div>
            <div class="card"><small>PROGRESSION MISSION :</small><div class="prog-container"><div id="mission-progress-bar" class="prog-bar"></div></div><div id="mission-progress-text" style="text-align:center; font-size:0.8rem; font-weight:bold;">0 / 0 wagons</div></div>
            
            <div class="card">
                <h4 style="margin:0 0 10px 0">üèÉ Relayeurs (choisir les 4)</h4>
                <div id="players-list"></div>
                <button class="btn-chrono" onclick="askValidation()">PRENDRE LE D√âPART</button>
            </div>

            <div id="inventory-zone" class="inventory"></div>

            <div class="card">
                <h4 style="margin:0 0 10px 0">‚è±Ô∏è Historique Relais</h4>
                <table class="hist-table">
                    <thead><tr><th>Relais</th><th>Cible</th><th>R√©al.</th><th>Note</th></tr></thead>
                    <tbody id="relais-table-body"></tbody>
                </table>
            </div>

            <div class="card">
                <h3 style="margin:0">üõ§ Poser un rail</h3>
                <select id="sel-a"></select> vers <select id="sel-b"></select>
                <button class="btn-valid" onclick="buildRoute()">CONSTRUIRE LE RAIL</button>
            </div>

            <div class="card" style="border-left-color: var(--b);">
                <h4 style="margin:0 0 10px 0">üìú Historique Rails</h4>
                <table class="hist-table">
                    <thead><tr><th>Heure</th><th>Trajet</th><th>Co√ªt</th></tr></thead>
                    <tbody id="rail-table-body"></tbody>
                </table>
            </div>
            <button onclick="resetGame()" style="background:var(--d); color:white; border:none; margin-top:30px; padding:8px; font-size:0.7rem;">R√âINITIALISER TOUT</button>
        </div>
        <div id="banner-game-bottom" class="banner-flow"></div>
    </div>

    <div id="screen-map" class="screen">
        <div id="banner-map-top" class="banner-flow"></div>
        <button class="btn-nav" style="margin:10px auto; width:90%;" onclick="showScreen('screen-game')">‚¨Ö RETOUR</button>
        <div id="map-area">
            <div style="position:fixed; bottom:80px; right:20px; z-index:100; display:flex; flex-direction:column; gap:10px;">
                <button class="btn-zoom" onclick="zoomMap(0.2)">+</button><button class="btn-zoom" onclick="zoomMap(-0.2)">-</button>
            </div>
            <div id="map-container"><embed src="carte.svg" type="image/svg+xml"></div>
        </div>
        <div id="banner-map-bottom" class="banner-flow"></div>
    </div>

    <div id="modal-qr" class="modal">
        <div class="modal-content">
            <h3 id="qr-title">Pr√™t ?</h3>
            <div id="chrono-zone">
                <div style="color:var(--b); font-weight:bold;">Cible : <span id="target-live">0.00</span>s</div>
                <div id="chrono-display">0.00</div>
                <button id="btn-chrono-toggle" class="btn-chrono" onclick="toggleChrono()">D√âPART</button>
            </div>
            <div id="qr-success-zone" style="display:none;">
                <div id="qrcode" style="display:flex; justify-content:center; margin:15px;"></div>
                <input type="number" id="input-pin" style="font-size: 2.5rem; text-align: center;" placeholder="PIN">
                <button class="btn-valid" onclick="checkPin()">CONFIRMER LE PIN</button>
            </div>
            <button class="btn-cancel" onclick="closeModalQR()" style="margin-top:10px;">ANNULER / FERMER</button>
        </div>
    </div>

    <div id="modal-chance" class="modal"><div class="modal-content"><h2>Bravo !</h2><p>Gagne <b id="wagon-count">0</b> wagon(s) :</p><div id="chance-buttons" class="inventory" style="justify-content:center"></div></div></div>

    <div id="modal-win" class="modal">
        <div class="modal-content" style="background:#f1c40f;">
            <h1>üèÜ VICTOIRE !</h1>
            <button class="btn-valid" onclick="startSecondaryMission()" style="background:#2ecc71;">MISSION SECONDAIRE (+ courte)</button>
            <button class="btn-valid" onclick="resetGame()" style="background:#e67e22; margin-top:10px;">REJOUER (Nouvelle partie)</button>
        </div>
    </div>

<script>
const RAIL_DATA = [{u:"Calais",v:"Dunkerque",cost:1,col:["jaune"]},{u:"Dunkerque",v:"Lille",cost:2,col:["bleu"]},{u:"Dunkerque",v:"B√©thune",cost:3,col:["rouge"]},{u:"B√©thune",v:"Douai",cost:1,col:["blanc"]},{u:"Douai",v:"Amiens",cost:2,col:["bleu"]},{u:"Douai",v:"Valenciennes",cost:2,col:["noire"]},{u:"Lille",v:"Valenciennes",cost:4,col:["orange"]},{u:"Valenciennes",v:"Thionville",cost:5,col:["noire","rose"]},{u:"Valenciennes",v:"Reims",cost:2,col:["jaune"]},{u:"Amiens",v:"Paris",cost:3,col:["orange","vert"]},{u:"Amiens",v:"Le Havre",cost:4,col:["rouge"]},{u:"Le Havre",v:"Rouen",cost:2,col:["noire"]},{u:"Rouen",v:"Paris",cost:3,col:["blanc"]},{u:"Paris",v:"Troyes",cost:7,col:["rose","jaune"]},{u:"Reims",v:"Nancy",cost:5,col:["rouge"]},{u:"Reims",v:"Troyes",cost:4,col:["vert"]},{u:"Nancy",v:"Troyes",cost:2,col:["bleu"]},{u:"Thionville",v:"Nancy",cost:3,col:["orange"]},{u:"Thionville",v:"Strasbourg",cost:5,col:["rose"]},{u:"Nancy",v:"Strasbourg",cost:4,col:["jaune"]},{u:"Strasbourg",v:"Mulhouse",cost:3,col:["blanc"]},{u:"Mulhouse",v:"Montb√©liard",cost:1,col:["vert"]},{u:"Montb√©liard",v:"Besan√ßon",cost:2,col:["jaune"]},{u:"Besan√ßon",v:"Troyes",cost:3,col:["rouge","vert"]},{u:"Besan√ßon",v:"Dijon",cost:2,col:["bleu"]},{u:"Besan√ßon",v:"Annecy",cost:4,col:["blanc"]},{u:"Dijon",v:"Lyon",cost:4,col:["jaune","rouge"]},{u:"Le Havre",v:"Caen",cost:1,col:["bleu"]},{u:"Paris",v:"Le Mans",cost:4,col:["vert"]},{u:"Paris",v:"Orl√©ans",cost:4,col:["rouge","bleu"]},{u:"Orl√©ans",v:"Le Mans",cost:3,col:["blanc"]},{u:"Le Mans",v:"Rennes",cost:5,col:["vert"]},{u:"Caen",v:"Le Mans",cost:4,col:["orange"]},{u:"Caen",v:"Rennes",cost:5,col:["blanc","rose"]},{u:"Rennes",v:"Brest",cost:7,col:["rouge"]},{u:"Brest",v:"Lorient",cost:3,col:["orange"]},{u:"Lorient",v:"Saint-Nazaire",cost:3,col:["jaune"]},{u:"Rennes",v:"Saint-Nazaire",cost:3,col:["noire"]},{u:"Rennes",v:"Nantes",cost:3,col:["bleu"]},{u:"Nantes",v:"Saint-Nazaire",cost:2,col:["blanc"]},{u:"Nantes",v:"Angers",cost:2,col:["rouge"]},{u:"Angers",v:"Tours",cost:3,col:["bleu"]},{u:"Tours",v:"Orl√©ans",cost:3,col:["vert"]},{u:"Nantes",v:"Poitiers",cost:5,col:["rose"]},{u:"Tours",v:"Poitiers",cost:2,col:["blanc"]},{u:"Nantes",v:"Bordeaux",cost:8,col:["noire","orange"]},{u:"Poitiers",v:"Limoges",cost:3,col:["rouge"]},{u:"Limoges",v:"Bordeaux",cost:5,col:["vert","bleu"]},{u:"Limoges",v:"Clermont-Ferrand",cost:4,col:["blanc","jaune"]},{u:"Clermont-Ferrand",v:"Lyon",cost:2,col:["orange"]},{u:"Clermont-Ferrand",v:"Saint-Etienne",cost:3,col:["rouge"]},{u:"Lyon",v:"Saint-Etienne",cost:1,col:["vert"]},{u:"Lyon",v:"Grenoble",cost:4,col:["bleu"]},{u:"Grenoble",v:"Annecy",cost:3,col:["vert"]},{u:"Saint-Etienne",v:"Valence",cost:2,col:["noire"]},{u:"Valence",v:"N√Æmes",cost:4,col:["rouge","jaune"]},{u:"N√Æmes",v:"Montpellier",cost:2,col:["orange","bleu"]},{u:"N√Æmes",v:"Marseille",cost:1,col:["blanc","bleu"]},{u:"Marseille",v:"Toulon",cost:2,col:["jaune"]},{u:"Toulon",v:"Nice",cost:3,col:["vert"]},{u:"Montpellier",v:"Toulouse",cost:4,col:["rouge","vert"]},{u:"Toulouse",v:"Perpignan",cost:3,col:["blanc"]},{u:"Toulouse",v:"Pau",cost:5,col:["jaune"]},{u:"Toulouse",v:"Bordeaux",cost:6,col:["rose"]},{u:"Bordeaux",v:"Pau",cost:6,col:["rouge"]},{u:"Pau",v:"Bayonne",cost:4,col:["vert"]},{u:"Orl√©ans",v:"Limoges",cost:7,col:["jaune", "bleu"]}];
const MISSIONS = [{s:"Calais",e:"Besan√ßon",w:16},{s:"Dunkerque",e:"Tours",w:16},{s:"Lorient",e:"Amiens",w:16}];
const MISSIONS_SEC = [{s:"Nancy",e:"Dijon",w:6},{s:"Paris",e:"Rouen",w:5},{s:"Lyon",e:"Grenoble",w:4}];
const BAREMES = { "4Filles": [38.8,38.7,38.3,37.9,37.5,37.2,36.8,36.5,36.1,35.8,35.4,35.1,34.7,34.4,34.0,33.7,33.3,33.0,32.6,32.3,32.0,31.7,31.4,31.1,30.8], "3Filles": [37.0,36.9,36.5,36.2,35.7,35.4,35.1,34.8,34.5,34.2,33.9,33.6,33.2,33.0,32.6,32.3,32.0,31.7,31.3,31.0,30.7,30.4,29.1,29.8,29.5], "2Filles": [35.2,35.1,34.8,34.5,33.9,33.6,33.3,33.1,32.9,32.6,32.3,32.1,31.8,31.5,31.2,31.0,30.7,30.4,30.0,29.7,29.4,29.1,28.8,28.5,28.1], "1Filles": [33.3,33.2,33.0,32.7,32.1,31.8,31.6,31.3,31.2,31.0,30.8,30.5,30.3,30.1,29.8,29.6,29.3,29.0,28.7,28.4,28.1,27.8,27.5,27.1,26.8], "0Filles": [31.5,31.4,31.2,31.0,30.8,30.6,30.4,30.2,30.0,29.8,29.6,29.4,29.2,29.0,28.8,28.6,28.4,28.2,28.0,27.7,27.4,27.1,26.8,26.5,26.4] };
const POINTS = [0,0.25,0.5,0.75,1,1.25,1.5,1.75,2,2.25,2.5,2.75,3,3.25,3.5,3.75,4,4.25,4.5,4.75,5,5.25,5.5,5.75,6]; 

let state = { scale: 1, color: null, mission: null, built: [], distance: 0, inv: {jaune:0,orange:0,rose:0,noire:0,vert:0,bleu:0,rouge:0,blanc:0}, individual: {}, targetWagons: 0, currentPin: null, pendingWagons: 0, relaisHistory: [], selectedRelayers: [] };
let timer = null, startTime = 0, currentTime = 0;

function clean(s) { return s.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, ''); }
function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
function saveGame() { localStorage.setItem('rf_v40_final', JSON.stringify(state)); }
function checkSave() { let s = localStorage.getItem('rf_v40_final'); if(s) { state = JSON.parse(s); setupCities(); showScreen('screen-game'); updateUI(); } }
function resetGame() { if(confirm("Supprimer toute la progression ?")) { localStorage.clear(); location.reload(); } }

function updateBanners() {
    const col = document.getElementById('team-color').value || state.color;
    document.querySelectorAll('.banner-flow').forEach(b => { b.className = 'banner-flow ' + col; });
}

function setupCities() {
    let c = [...new Set(RAIL_DATA.flatMap(r => [r.u, r.v]))].sort();
    let sa = document.getElementById('sel-a'), sb = document.getElementById('sel-b');
    sa.innerHTML = sb.innerHTML = ""; c.forEach(x => { sa.add(new Option(x,x)); sb.add(new Option(x,x)); });
}

function startGame() {
    let inputs = Array.from(document.querySelectorAll('.input-names')), targets = Array.from(document.querySelectorAll('.input-targets')), sexes = Array.from(document.querySelectorAll('.input-sex')), valid = 0;
    inputs.forEach((inp, i) => {
        let name = inp.value.trim(), target = parseFloat(targets[i].value);
        if(name !== "" && !isNaN(target)) { 
            let sexCode = sexes[i].value === "F" ? "2" : "1";
            state.individual[clean(name)] = { target: target, realName: name, letter: String.fromCharCode(65 + valid) + sexCode }; 
            valid++; 
        }
    });
    if(valid < 4) return alert("Min 4 √©l√®ves");
    state.color = document.getElementById('team-color').value;
    updateBanners();
    let m = MISSIONS[Math.floor(Math.random()*MISSIONS.length)];
    state.mission = {s: m.s, e: m.e}; state.targetWagons = m.w;
    setupCities(); showScreen('screen-game'); saveGame(); updateUI();
}

function handlePlayerSelect(checkbox, nameKey) {
    if (checkbox.checked) {
        if (state.selectedRelayers.length >= 4) { checkbox.checked = false; return; }
        state.selectedRelayers.push(nameKey);
    } else {
        state.selectedRelayers = state.selectedRelayers.filter(n => n !== nameKey);
    }
    updateUI();
}

function calculateNote(temps, playersKeys) {
    let nbFilles = playersKeys.filter(k => state.individual[k].letter.includes("2")).length;
    let nomBareme = nbFilles + "Filles";
    let baremeChoisi = BAREMES[nomBareme];
    
    let note = 0;
    for (let i = baremeChoisi.length - 1; i >= 0; i--) {
        if (temps <= baremeChoisi[i]) {
            note = POINTS[i];
            break; 
        }
    }
    return note.toFixed(2);
}

function updateUI() {
    updateBanners();
    document.getElementById('team-score-card').className = "card " + state.color;
    document.getElementById('dist-team').innerText = state.distance + " m";
    document.getElementById('m-title').innerText = "üìç MISSION : " + state.mission.s + " ‚ûî " + state.mission.e;
    let curW = state.built.reduce((acc, b) => acc + (b.cost || 0), 0);
    document.getElementById('mission-progress-bar').style.width = Math.min(100, (curW/state.targetWagons)*100) + "%";
    document.getElementById('mission-progress-text').innerText = `${curW} / ${state.targetWagons} wagons`;
    
    let pl = document.getElementById('players-list'); pl.innerHTML = "";
    for(let n in state.individual) {
        let p = state.individual[n], idx = state.selectedRelayers.indexOf(n);
        let badgeLetter = p.letter.replace(/[12]/g, '');
        pl.innerHTML += `<div class="player-row">
            <div><span class="id-badge">${badgeLetter}</span><span>${p.realName}</span><br><small>R√©f: ${p.target}s</small>${idx!==-1?`<span class="order-badge">${idx+1}</span>`:''}</div>
            <input type="checkbox" class="chk-relais" ${idx!==-1?'checked':''} onchange="handlePlayerSelect(this, '${n}')">
        </div>`;
    }
    let iz = document.getElementById('inventory-zone'); iz.innerHTML = "";
    for(let c in state.inv) if(state.inv[c]>0) iz.innerHTML += `<div class="wagon-pill ${c}">${state.inv[c]}</div>`;

    document.getElementById('relais-table-body').innerHTML = state.relaisHistory.map(h => `<tr><td><b>${h.names.replace(/[12-]/g, '')}</b></td><td>${h.theo}s</td><td>${h.real}s</td><td>${h.note}/6</td></tr>`).reverse().join('');
    document.getElementById('rail-table-body').innerHTML = state.built.map(r => `<tr><td>${r.h}</td><td>${r.u} ‚Üî ${r.v}</td><td><div class="wagon-pill ${r.col}" style="padding:4px 8px; font-size:0.7rem;">${r.cost}</div></td></tr>`).reverse().join('');
}

function askValidation() {
    if(state.selectedRelayers.length !== 4) return alert("S√©lectionnez 4 !");
    const btn = document.getElementById('btn-chrono-toggle');
    btn.innerText = "D√âPART"; btn.style.background = "var(--p)";
    document.getElementById('chrono-display').innerText = "0.00";
    state.currentTheorique = state.selectedRelayers.reduce((sum, n) => sum + state.individual[n].target, 0).toFixed(2);
    const compoVisuelle = state.selectedRelayers.map(n => state.individual[n].letter.replace(/[12]/g, '')).join('');
    state.currentPin = Math.floor(100 + Math.random() * 899);
    document.getElementById('qr-title').innerHTML = `Relais : <span style="color:var(--d)">${compoVisuelle}</span>`;
    document.getElementById('target-live').innerText = state.currentTheorique;
    document.getElementById('qr-success-zone').style.display = "none";
    document.getElementById('chrono-zone').style.display = "block";
    document.getElementById('modal-qr').style.display = 'flex';
}

function toggleChrono() {
    let btn = document.getElementById('btn-chrono-toggle');
    if(btn.innerText === "D√âPART") {
        startTime = Date.now(); btn.innerText = "STOP"; btn.style.background = "var(--d)";
        timer = setInterval(() => { currentTime = ((Date.now() - startTime) / 1000).toFixed(2); document.getElementById('chrono-display').innerText = currentTime; }, 50);
    } else {
        clearInterval(timer); timer = null;
        document.getElementById('chrono-zone').style.display = "none";
        document.getElementById('qr-success-zone').style.display = "block";
        let qrDiv = document.getElementById('qrcode'); qrDiv.innerHTML = "";
        const data = { team: state.color, player: state.selectedRelayers.map(n => state.individual[n].letter).join('-'), pin: state.currentPin, id: Date.now(), tempsRealise: currentTime, tempsCible: state.currentTheorique };
        new QRCode(qrDiv, { text: JSON.stringify(data), width: 180, height: 180 });
    }
}

function checkPin() {
    if(parseInt(document.getElementById('input-pin').value) === state.currentPin) {
        state.distance += 200;
        let noteObtenue = calculateNote(parseFloat(currentTime), state.selectedRelayers);
        state.relaisHistory.push({ names: state.selectedRelayers.map(n => state.individual[n].letter).join('-'), theo: state.currentTheorique, real: currentTime, note: noteObtenue });
        let diff = state.currentTheorique - currentTime;
        if(diff < -0.2) state.pendingWagons = 1; else if(diff <= 0.2) state.pendingWagons = 1; else if(diff < 1.0) state.pendingWagons = 2; else if(diff < 1.3) state.pendingWagons = 3; else if(diff < 1.9) state.pendingWagons = 4; else state.pendingWagons = 5;
        document.getElementById('modal-qr').style.display = 'none';
        document.getElementById('input-pin').value = "";
        showChanceModal(); saveGame(); updateUI();
    } else alert("PIN incorrect");
}

function showChanceModal() {
    if(state.pendingWagons <= 0) { document.getElementById('modal-chance').style.display = "none"; return; }
    document.getElementById('wagon-count').innerText = state.pendingWagons;
    let pk = ['jaune','orange','rose','noire','vert','bleu','rouge','blanc'].sort(()=>0.5-Math.random()).slice(0,4);
    let ct = document.getElementById('chance-buttons'); ct.innerHTML = "";
    pk.forEach(c => {
        let b = document.createElement('button'); b.className = `wagon-pill ${c}`; b.innerText = c.toUpperCase();
        b.onclick = () => { state.inv[c]++; state.pendingWagons--; saveGame(); updateUI(); if(state.pendingWagons > 0) showChanceModal(); else document.getElementById('modal-chance').style.display="none"; };
        ct.appendChild(b);
    });
    document.getElementById('modal-chance').style.display = "flex";
}

function buildRoute() {
    let a = document.getElementById('sel-a').value, b = document.getElementById('sel-b').value;
    if(a === b) return alert("Erreur : Vous avez s√©lectionn√© deux fois la m√™me ville !");
    let r = RAIL_DATA.find(x => (x.u === a && x.v === b) || (x.v === a && x.u === b));
    if(!r) return alert("Erreur : Ce rail n'existe pas sur la carte !");
    let exist = state.built.find(x => (x.u === a && x.v === b) || (x.v === a && x.u === b));
    if(exist) return alert("Attention : Ce rail a d√©j√† √©t√© construit !");
    
    let col = r.col.length > 1 ? prompt(`Couleur (${r.col.join('/')}) ?`).toLowerCase() : r.col[0];
    if(state.inv[col] >= r.cost) { 
        state.inv[col] -= r.cost; 
        let now = new Date();
        state.built.push({u:a, v:b, cost: r.cost, col: col, h: now.getHours()+":"+now.getMinutes().toString().padStart(2,'0')}); 
        saveGame(); updateUI(); 
        checkWin(); 
    } else {
        alert(`Action impossible : Il vous manque des wagons ${col.toUpperCase()} ! (Besoin : ${r.cost}, Stock : ${state.inv[col]})`);
    }
}

function checkWin() {
    let v = new Set(), q = [state.mission.s];
    while(q.length > 0) {
        let curr = q.shift(); if(curr === state.mission.e) { document.getElementById('modal-win').style.display='flex'; return; }
        v.add(curr); state.built.forEach(r => { 
            if(r.u==curr && !v.has(r.v)) q.push(r.v); if(r.v==curr && !v.has(r.u)) q.push(r.u); 
        });
    }
}

function startSecondaryMission() {
    let m = MISSIONS_SEC[Math.floor(Math.random()*MISSIONS_SEC.length)];
    state.mission = {s: m.s, e: m.e};
    state.targetWagons = m.w;
    state.isSecondary = true;
    document.getElementById('modal-win').style.display='none';
    saveGame(); updateUI();
}

function zoomMap(v) { state.scale += v; document.getElementById('map-container').style.transform = `scale(${state.scale})`; }
function closeModalQR() { clearInterval(timer); timer = null; document.getElementById('modal-qr').style.display = 'none'; }
</script>
</body>
</html>