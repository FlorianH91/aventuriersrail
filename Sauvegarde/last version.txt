<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aventuriers du Rail-Fond</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    
    <style>
        :root { --p: #2c3e50; --s: #27ae60; --accent: #f39c12; --danger: #e74c3c; }
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f0f2f5; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        #screen-home { 
            height: 100vh; display: flex; align-items: center; justify-content: center; 
            background: radial-gradient(circle at center, #2e3192, #1b1464);
            position: fixed; inset: 0; z-index: 1000; color: white; text-align: center;
        }
        .card-menu { 
            background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border: 2px solid rgba(255,255,255,0.1);
            border-radius: 30px; padding: 40px; cursor: pointer; transition: 0.3s; margin: 10px; display: inline-block; width: 300px;
        }
        .card-menu:hover { transform: scale(1.05); border-color: #00d2ff; }

        #app { display: none; height: 100%; width: 100%; flex-direction: row; }
        /* MODIFICATION : Sidebar avec scroll auto */
        #sidebar { width: 340px; background: white; border-right: 2px solid #ddd; display: flex; flex-direction: column; overflow-y: auto; flex-shrink: 0; height: 100%; }
        .padding { padding: 15px; }
        
        #map-area { flex-grow: 1; background: #cbdceb; overflow: auto; position: relative; display: flex; align-items: flex-start; justify-content: center; }
        #map-container { transform-origin: top center; transition: transform 0.3s ease; }
        embed { width: 1000px; height: 960px; pointer-events: none; }
        
        .controls-map { position: absolute; bottom: 20px; right: 20px; z-index: 20; display: flex; flex-direction: column; gap: 10px; }
        .btn-zoom { background: #2c3e50; color: white; border: 2px solid white; width: 50px; height: 50px; border-radius: 8px; cursor: pointer; font-size: 1.2rem; font-weight: bold; }
        .btn-fit { width: 80px; font-size: 0.8rem; align-self: flex-end; }

        .card { background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 12px; margin-bottom: 10px; border-left: 5px solid var(--p); }
        .player-row { display: flex; justify-content: space-between; padding: 10px; background: #f8f9fa; border-radius: 6px; margin-bottom: 5px; cursor: pointer; border: 1px solid #eee; font-weight: bold; }
        .inventory { display: flex; flex-wrap: wrap; gap: 4px; margin: 10px 0; }
        .wagon-pill { padding: 4px 8px; border-radius: 4px; font-weight: bold; border: 1px solid #333; font-size: 0.8rem; }
        
        select, input, button { width: 100%; padding: 10px; margin-top: 5px; border-radius: 6px; border: 1px solid #ccc; font-size: 1rem; }
        .input-names { margin-bottom: 5px; border-left: 3px solid var(--accent); }
        button { background: var(--p); color: white; border: none; font-weight: bold; cursor: pointer; }
        .btn-build { background: var(--s); }
        .btn-reset { background: var(--danger); margin-top: 20px; }
        
        .jaune { background: #FFD700; color: #000; } 
        .blanc { background: #fff; color: #000; border: 1px solid #ccc; } 
        .orange { background: #FF8C00; color: white; }
        .rose { background: #FF69B4; color: white; } 
        .noire { background: #222; color: white; }
        .vert { background: #2E7D32; color: white; } 
        .bleu { background: #1E90FF; color: white; }
        .rouge { background: #DC143C; color: white; }

        .collective-goal { background: #2c3e50; color: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; }
        .progress-container { background: #444; border-radius: 10px; height: 18px; width: 100%; margin-top: 5px; overflow: hidden; position: relative; }
        .progress-bar { background: var(--s); height: 100%; width: 0%; transition: 0.8s ease-in-out; }
        .progress-text { position: absolute; width: 100%; text-align: center; font-size: 0.7rem; line-height: 18px; color: white; font-weight: bold; }
        
        .prof-card { background: white; border-left: 8px solid var(--p); padding: 15px; margin-bottom: 12px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .trajets-list { font-size: 0.75rem; color: #7f8c8d; margin-top: 5px; font-style: italic; }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal-content { background: white; padding: 25px; border-radius: 15px; text-align: center; width: 90%; max-width: 400px; color: #333; }
        
        @media (max-width: 768px) {
            #app { flex-direction: column; }
            #sidebar { width: 100%; height: auto; min-height: 40vh; border-right: none; border-bottom: 2px solid #ddd; overflow-y: scroll; }
        }
    </style>
</head>
<body>

<div id="screen-home">
    <div>
        <h1>Les Aventuriers du Rail-Fond</h1>
        <div class="card-menu" onclick="openApp('eleve')"><h2>√âL√àVES</h2><p>Lancer une mission</p></div>
        <div class="card-menu" onclick="openApp('prof')"><h2>PROFESSEUR</h2><p>Suivi & Gestion</p></div>
    </div>
</div>

<div id="app">
    <div id="sidebar">
        <div id="screen-setup" class="padding">
            <button onclick="location.reload()" style="background:#7f8c8d; margin-bottom:20px;">‚Üê Retour</button>
            <h2>üöÇ Configuration</h2>
            <div id="names-container">
                <input type="text" class="input-names" placeholder="Pr√©nom 1">
                <input type="text" class="input-names" placeholder="Pr√©nom 2">
                <input type="text" class="input-names" placeholder="Pr√©nom 3">
                <input type="text" class="input-names" placeholder="Pr√©nom 4">
                <input type="text" class="input-names" placeholder="Pr√©nom 5">
            </div>
            <select id="team-color">
                <option value="rouge">üî¥ Rouge</option>
                <option value="bleu">üîµ Bleue</option>
                <option value="vert">üü¢ Verte</option>
                <option value="jaune">üü° Jaune</option>
            </select>
            <button onclick="startGame()" style="background:var(--s); margin-top:15px;">Commencer</button>
        </div>

        <div id="screen-game" class="padding" style="display:none">
            <button onclick="location.reload()" style="background:#7f8c8d; margin-bottom:10px;">Quitter</button>
            <div class="card" style="background: #2c3e50; color: white; text-align: center;">
                <small>DISTANCE √âQUIPE :</small><br><strong style="font-size: 1.5rem;" id="dist-team">0 m</strong>
            </div>
            <div class="card" style="background: var(--p); color: white;">
                <strong>üìç MISSION :</strong> <span id="m-title"></span>
            </div>
            <div id="players-list"></div>
            <div id="inventory-zone" class="inventory"></div>
            <div class="card">
                <h3>üõ§ Acheter un rail</h3>
                <select id="sel-a"></select> vers <select id="sel-b"></select>
                <button class="btn-build" onclick="buildRoute()">Valider le trajet</button>
            </div>
        </div>

        <div id="screen-prof" class="padding" style="display:none;">
            <div style="display:flex; gap:10px;">
                <button onclick="location.reload()" style="background:#7f8c8d;">‚Üê Retour</button>
                <button onclick="confirmReset()" class="btn-reset" style="margin:0;">R.A.Z</button>
            </div>
            <div class="collective-goal" style="margin-top:15px;">
                <div style="display:flex; justify-content:space-between">
                    <b>Objectif : 10 000m</b>
                    <b id="collective-total">0 m</b>
                </div>
                <div class="progress-container"><div id="collective-bar" class="progress-bar"></div></div>
            </div>
            <div id="prof-pending"></div>
            <div id="prof-teams"></div>
        </div>
    </div>

    <div id="map-area">
        <div class="controls-map">
            <button class="btn-zoom" onclick="zoomMap(0.2)">+</button>
            <button class="btn-zoom" onclick="zoomMap(-0.2)">-</button>
            <button class="btn-zoom btn-fit" onclick="fitMap()">AJUSTER</button>
        </div>
        <div id="map-container">
            <embed id="svg-embed" src="carte.svg" type="image/svg+xml">
        </div>
    </div>
</div>

<div id="modal-wait" class="modal"><div class="modal-content"><h2>‚åõ Validation...</h2><p>Le professeur valide ton tour.</p></div></div>
<div id="modal-chance" class="modal"><div class="modal-content"><h2>Bravo !</h2><p>Choisis un wagon :</p><div id="chance-buttons" class="inventory" style="justify-content:center"></div></div></div>
<div id="modal-win" class="modal"><div class="modal-content" style="background:gold"><h1>üèÜ VICTOIRE !</h1><button onclick="location.reload()">Terminer</button></div></div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyAZgcf2PQ6DfOs3GYW0_ZC5xr09Bhku604",
    authDomain: "les-aventuriers-du-rail-b1965.firebaseapp.com",
    databaseURL: "https://les-aventuriers-du-rail-b1965-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "les-aventuriers-du-rail-b1965",
    storageBucket: "les-aventuriers-du-rail-b1965.firebasestorage.app",
    messagingSenderId: "435651671027",
    appId: "1:435651671027:web:a0be96b04f13306fe89886"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const MISSIONS_3 = [{s:"Calais", e:"Troyes", target:13},{s:"Nancy", e:"Grenoble", target:12},{s:"Caen", e:"Poitiers", target:12}];
const MISSIONS_4 = [{s:"Calais", e:"Strasbourg", target:17},{s:"Nice", e:"Bordeaux", target:22},{s:"Lorient", e:"Dijon", target:18}];
const MISSIONS_5 = [{s:"Bayonne", e:"Strasbourg", target:25},{s:"Brest", e:"Nice", target:28},{s:"Dunkerque", e:"Perpignan", target:24}];

const RAIL_DATA = [
    {u:"Calais", v:"Dunkerque", cost:1, col:["jaune"]}, {u:"Dunkerque", v:"Lille", cost:2, col:["bleu"]},
    {u:"Dunkerque", v:"B√©thune", cost:3, col:["rouge"]}, {u:"B√©thune", v:"Douai", cost:1, col:["blanc"]},
    {u:"Douai", v:"Amiens", cost:2, col:["bleu"]}, {u:"Douai", v:"Valenciennes", cost:2, col:["noire"]},
    {u:"Lille", v:"Valenciennes", cost:4, col:["orange"]}, {u:"Valenciennes", v:"Thionville", cost:5, col:["noire","rose"]},
    {u:"Valenciennes", v:"Reims", cost:2, col:["jaune"]}, {u:"Amiens", v:"Paris", cost:3, col:["orange","vert"]},
    {u:"Amiens", v:"Le Havre", cost:4, col:["rouge"]}, {u:"Le Havre", v:"Rouen", cost:2, col:["noire"]},
    {u:"Rouen", v:"Paris", cost:3, col:["blanc"]}, {u:"Paris", v:"Troyes", cost:7, col:["rose","jaune"]},
    {u:"Reims", v:"Nancy", cost:5, col:["rouge"]}, {u:"Reims", v:"Troyes", cost:4, col:["vert"]},
    {u:"Thionville", v:"Nancy", cost:3, col:["orange"]}, {u:"Thionville", v:"Strasbourg", cost:5, col:["rose"]},
    {u:"Nancy", v:"Strasbourg", cost:4, col:["jaune"]}, {u:"Strasbourg", v:"Mulhouse", cost:3, col:["blanc"]},
    {u:"Mulhouse", v:"Montb√©liard", cost:1, col:["vert"]}, {u:"Montb√©liard", v:"Besan√ßon", cost:2, col:["jaune"]},
    {u:"Besan√ßon", v:"Troyes", cost:3, col:["rouge","vert"]}, {u:"Besan√ßon", v:"Dijon", cost:2, col:["bleu"]},
    {u:"Besan√ßon", v:"Annecy", cost:4, col:["blanc"]}, {u:"Dijon", v:"Lyon", cost:4, col:["jaune","rouge"]},
    {u:"Le Havre", v:"Caen", cost:1, col:["bleu"]}, {u:"Paris", v:"Le Mans", cost:4, col:["vert"]},
    {u:"Paris", v:"Orl√©ans", cost:4, col:["rouge","bleu"]}, {u:"Orl√©ans", v:"Le Mans", cost:3, col:["blanc"]},
    {u:"Le Mans", v:"Rennes", cost:5, col:["vert"]}, {u:"Caen", v:"Le Mans", cost:4, col:["orange"]},
    {u:"Caen", v:"Rennes", cost:5, col:["blanc","rose"]}, {u:"Rennes", v:"Brest", cost:7, col:["rouge"]},
    {u:"Brest", v:"Lorient", cost:3, col:["orange"]}, {u:"Lorient", v:"Saint-Nazaire", cost:3, col:["jaune"]},
    {u:"Rennes", v:"Saint-Nazaire", cost:3, col:["noire"]}, {u:"Rennes", v:"Nantes", cost:3, col:["bleu"]},
    {u:"Nantes", v:"Saint-Nazaire", cost:2, col:["blanc"]}, {u:"Nantes", v:"Angers", cost:2, col:["rouge"]},
    {u:"Angers", v:"Tours", cost:3, col:["bleu"]}, {u:"Tours", v:"Orl√©ans", cost:3, col:["vert"]},
    {u:"Nantes", v:"Poitiers", cost:5, col:["rose"]}, {u:"Tours", v:"Poitiers", cost:2, col:["blanc"]},
    {u:"Nantes", v:"Bordeaux", cost:8, col:["noire","orange"]}, {u:"Poitiers", v:"Limoges", cost:3, col:["rouge"]},
    {u:"Limoges", v:"Bordeaux", cost:5, col:["vert","bleu"]}, {u:"Limoges", v:"Clermont-Ferrand", cost:4, col:["blanc","jaune"]},
    {u:"Clermont-Ferrand", v:"Lyon", cost:2, col:["orange"]}, {u:"Clermont-Ferrand", v:"Saint-Etienne", cost:3, col:["rouge"]},
    {u:"Lyon", v:"Saint-Etienne", cost:1, col:["vert"]}, {u:"Lyon", v:"Grenoble", cost:4, col:["bleu"]},
    {u:"Grenoble", v:"Annecy", cost:3, col:["vert"]}, {u:"Saint-Etienne", v:"Valence", cost:2, col:["noire"]},
    {u:"Valence", v:"N√Æmes", cost:4, col:["rouge","jaune"]}, {u:"N√Æmes", v:"Montpellier", cost:2, col:["orange","bleu"]},
    {u:"N√Æmes", v:"Marseille", cost:1, col:["blanc","bleu"]}, {u:"Marseille", v:"Toulon", cost:2, col:["jaune"]},
    {u:"Toulon", v:"Nice", cost:3, col:["vert"]}, {u:"Montpellier", v:"Toulouse", cost:4, col:["rouge","vert"]},
    {u:"Toulouse", v:"Perpignan", cost:3, col:["blanc"]}, {u:"Toulouse", v:"Pau", cost:5, col:["jaune"]},
    {u:"Toulouse", v:"Bordeaux", cost:6, col:["rose"]}, {u:"Bordeaux", v:"Pau", cost:6, col:["rouge"]},
    {u:"Pau", v:"Bayonne", cost:4, col:["vert"]},
    {u:"Orl√©ans", v:"Limoges", cost:7, col:["jaune", "bleu"]}
];

let state = { scale: 1, teamId: null, color: null, mission: null, built: [], currentPlayer: null };

function openApp(role) {
    if(role === 'prof') {
        if (prompt("Code Prof :") !== "EPS") return;
        document.getElementById('screen-home').style.display = 'none';
        document.getElementById('app').style.display = 'flex';
        document.getElementById('screen-setup').style.display = 'none';
        document.getElementById('screen-prof').style.display = 'block';
        document.getElementById('map-area').style.display = 'none';
        document.getElementById('sidebar').style.width = '100%';
        listenProf();
    } else {
        document.getElementById('screen-home').style.display = 'none';
        document.getElementById('app').style.display = 'flex';
    }
}

function startGame() {
    const names = Array.from(document.querySelectorAll('.input-names')).map(i=>i.value.trim()).filter(n=>n!=="");
    if(names.length < 1) return alert("Pr√©nom !");
    state.color = document.getElementById('team-color').value;
    state.teamId = state.color + "_" + Date.now();
    let pool = (names.length >= 5) ? MISSIONS_5 : (names.length === 4 ? MISSIONS_4 : MISSIONS_3);
    state.mission = pool[Math.floor(Math.random()*pool.length)];
    const ind = {}; names.forEach(n => ind[n] = 0);
    db.ref('teams/' + state.teamId).set({
        color: state.color, names: names.join(', '), distance: 0, 
        mission: state.mission, inv: {jaune:0,orange:0,rose:0,noire:0,vert:0,bleu:0,rouge:0,blanc:0},
        individual: ind, routes: []
    });
    const sa = document.getElementById('sel-a'), sb = document.getElementById('sel-b');
    const cities = [...new Set(RAIL_DATA.flatMap(r=>[r.u,r.v]))].sort();
    cities.forEach(c => { sa.add(new Option(c,c)); sb.add(new Option(c,c)); });
    document.getElementById('m-title').innerText = state.mission.s + " ‚ûî " + state.mission.e;
    document.getElementById('screen-setup').style.display = 'none';
    document.getElementById('screen-game').style.display = 'block';
    listenTeam();
}

function askValidation(name) {
    state.currentPlayer = name;
    document.getElementById('modal-wait').style.display = 'flex';
    db.ref('pending/' + state.teamId).set({ playerName: name, color: state.color, teamId: state.teamId });
}

function listenTeam() {
    db.ref('pending/' + state.teamId).on('value', snap => {
        if(!snap.exists() && document.getElementById('modal-wait').style.display === 'flex') {
            document.getElementById('modal-wait').style.display = 'none';
            showChanceModal();
        }
    });
    db.ref('teams/' + state.teamId).on('value', snap => {
        const data = snap.val(); if(!data) return;
        state.built = data.routes ? Object.values(data.routes) : [];
        document.getElementById('dist-team').innerText = data.distance + " m";
        const pl = document.getElementById('players-list'); pl.innerHTML = "<h3>Coureurs</h3>";
        for(let p in data.individual) pl.innerHTML += `<div class="player-row" onclick="askValidation('${p}')"><span>${p}</span><b>${data.individual[p]}m</b></div>`;
        const iz = document.getElementById('inventory-zone'); iz.innerHTML = "";
        for(let c in data.inv) if(data.inv[c]>0) iz.innerHTML += `<div class="wagon-pill ${c}">${data.inv[c]}</div>`;
        checkWin(data.mission);
    });
}

function showChanceModal() {
    const cols = ['jaune','orange','rose','noire','vert','bleu','rouge','blanc'];
    const pick = cols.sort(()=>0.5-Math.random()).slice(0,4);
    const cont = document.getElementById('chance-buttons'); cont.innerHTML = "";
    pick.forEach(c => {
        const b = document.createElement('button'); b.className = `wagon-pill ${c}`;
        b.innerText = c.toUpperCase(); b.onclick = () => {
            db.ref('teams/' + state.teamId + '/inv/' + c).transaction(n => (n||0)+1);
            db.ref('teams/' + state.teamId + '/distance').transaction(d => (d||0)+250);
            db.ref('teams/' + state.teamId + '/individual/' + state.currentPlayer).transaction(d => (d||0)+250);
            document.getElementById('modal-chance').style.display = "none";
        };
        cont.appendChild(b);
    });
    document.getElementById('modal-chance').style.display = "flex";
}

function buildRoute() {
    const a = document.getElementById('sel-a').value, b = document.getElementById('sel-b').value;
    const rail = RAIL_DATA.find(r => (r.u==a && r.v==b) || (r.u==b && r.v==a));
    if(!rail) return alert("Liaison impossible");
    let color = rail.col.length > 1 ? prompt(`Couleur (${rail.col.join('/')}) ?`).toLowerCase() : rail.col[0];
    db.ref('teams/' + state.teamId).once('value', snap => {
        const d = snap.val();
        if(d.inv[color] >= rail.cost) {
            db.ref('teams/' + state.teamId + '/inv/' + color).transaction(n => n - rail.cost);
            db.ref('teams/' + state.teamId + '/routes').push({u:a, v:b, cost: rail.cost});
            alert("Rail pos√© !");
        } else alert("Pas assez de wagons !");
    });
}

function listenProf() {
    db.ref('pending').on('value', snap => {
        const div = document.getElementById('prof-pending'); div.innerHTML = "<h3>En attente</h3>";
        snap.forEach(child => {
            const d = child.val();
            div.innerHTML += `<div class="prof-card" style="display:flex; justify-content:space-between; align-items:center;">
                <b>${d.playerName} (Team ${d.color})</b>
                <button onclick="db.ref('pending/${d.teamId}').remove()" style="width:auto; background:var(--s);">VALIDER</button>
            </div>`;
        });
    });
    db.ref('teams').on('value', snap => {
        const div = document.getElementById('prof-teams'); div.innerHTML = "<h3>√âquipes</h3>";
        let totalC = 0;
        snap.forEach(child => {
            const t = child.val(); totalC += t.distance;
            const rArr = t.routes ? Object.values(t.routes) : [];
            const wPoses = rArr.reduce((s, r) => s + (r.cost || 0), 0);
            const progress = Math.min((wPoses / (t.mission.target || 15)) * 100, 100);
            
            // MODIFICATION : R√©cup√©ration trajet + distances individuelles
            let trajetStr = rArr.map(r => `${r.u}-${r.v}`).join(', ');
            let indRes = "";
            for(let p in t.individual) indRes += `${p}: ${t.individual[p]}m | `;

            div.innerHTML += `<div class="prof-card" style="border-left-color:${t.color}">
                <b>TEAM ${t.color.toUpperCase()} - ${t.distance}m</b>
                <div class="progress-container"><div class="progress-bar" style="width:${progress}%"></div></div>
                <small>${wPoses} / ${t.mission.target} wagons</small>
                <div class="trajets-list">Rails: ${trajetStr || 'aucun'}</div>
                <div style="font-size:0.7rem; color:#666; margin-top:5px;">Indiv: ${indRes}</div>
            </div>`;
        });
        document.getElementById('collective-total').innerText = totalC + " m";
        document.getElementById('collective-bar').style.width = Math.min((totalC/10000)*100, 100) + "%";
    });
}

function checkWin(mission) {
    if(state.built.length === 0) return;
    let visited = new Set(), q = [mission.s];
    while(q.length > 0) {
        let curr = q.shift(); if(curr == mission.e) return document.getElementById('modal-win').style.display='flex';
        visited.add(curr);
        state.built.forEach(r => { 
            if(r.u==curr && !visited.has(r.v)) q.push(r.v); 
            if(r.v==curr && !visited.has(r.u)) q.push(r.u); 
        });
    }
}

function confirmReset() { if(confirm("R.A.Z ?")) { db.ref('teams').remove(); db.ref('pending').remove(); } }
function zoomMap(v) { state.scale += v; applyZoom(); }
function fitMap() { state.scale = document.getElementById('map-area').clientWidth / 1000; applyZoom(); }
function applyZoom() { document.getElementById('map-container').style.transform = `scale(${state.scale})`; }
</script>
</body>
</html>